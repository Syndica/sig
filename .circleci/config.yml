version: 2.1

orbs:
  codecov: codecov/codecov@5.4.3

commands:
  docker_as_user:
    description: "Configure Docker to run as the job user to prevent root-owned files in workspace"
    steps:
      - run:
          name: Configure docker user/mount defaults
          command: |
            echo 'export DOCKER_UID_GID="$(id -u):$(id -g)"' >> "$BASH_ENV"
            echo 'export DOCKER_MOUNT="-v $PWD:$PWD -w $PWD -e HOME=$PWD -u $DOCKER_UID_GID"' >> "$BASH_ENV"
            source "$BASH_ENV"

executors:
  linux-executor:
    machine: true
    resource_class: syndica/r7iz-fleet
  python-executor:
    docker:
      - image: cimg/python:3.10
  macos-executor:
    macos:
      xcode: 15.4.0
    resource_class: m4pro.medium

jobs:
  setup_zig:
    parameters:
      target:
        type: string
    executor: linux-executor
    steps:
      - checkout
      - run:
          name: Download Zig
          command: |
            sudo apt update && sudo apt install -y wget unzip xz-utils
            wget https://ziglang.org/download/0.14.1/zig-<< parameters.target >>-0.14.1.tar.xz
            tar xf zig-<< parameters.target >>-0.14.1.tar.xz
            mkdir -p workspace
            mv zig-<< parameters.target >>-0.14.1 workspace/zig
      - persist_to_workspace:
          root: workspace
          paths:
            - "*"

  lint:
    executor: linux-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - run:
          name: Lint
          command: |
            workspace/zig/zig fmt --check src/ build.zig
            cd conformance/
            ../workspace/zig/zig fmt --check src/ build.zig

  check_style:
    executor: python-executor
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install --upgrade pip
      - run:
          name: Check style
          command: python scripts/style.py --check src
      - run:
          name: Check style in conformance
          command: python scripts/style.py --check conformance/src

  check_docs:
    executor: python-executor
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install --upgrade pip
      - run:
          name: Check docs
          command: python docs/check.py ./
      - run:
          name: Check conformance commits
          command: conformance/scripts/verify-commits.sh

  build_linux:
    executor: linux-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - restore_cache:
          key: linux-x86_64-0.14.1-{{ checksum "build.zig.zon" }}-selfhosted
      - run:
          name: Build
          command: |
            sudo apt update && sudo apt install wget -y
            ./scripts/proxy_workaround.sh workspace/zig/zig
            workspace/zig/zig build -Denable-tsan=true -p workspace/zig-out -Dcpu=x86_64_v3 --summary all
      - save_cache:
          key: linux-x86_64-0.14.1-{{ checksum "build.zig.zon" }}-selfhosted
          paths:
            - .zig-cache
            - ~/.cache/zig
      - persist_to_workspace:
          root: workspace
          paths:
            - "zig-out/bin/test"

  build_linux_release:
    executor: linux-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - restore_cache:
          key: linux-x86_64-0.14.1-{{ checksum "build.zig.zon" }}-selfhosted-release
      - run:
          name: Build
          command: |
            sudo apt update && sudo apt install wget -y
            ./scripts/proxy_workaround.sh workspace/zig/zig
            workspace/zig/zig build sig fuzz -Dno-run -Denable-tsan=false -Doptimize=ReleaseSafe -Dcpu=x86_64_v3 -p workspace/zig-out-release --summary all
      - run:
          name: Build Conformance
          command: |
            cd conformance
            ../workspace/zig/zig build -Doptimize=ReleaseSafe -Dcpu=x86_64_v3 -p ../workspace/conformance-release --summary all
      - save_cache:
          key: linux-x86_64-0.14.1-{{ checksum "build.zig.zon" }}-selfhosted-release
          paths:
            - .zig-cache
            - ~/.cache/zig
      - persist_to_workspace:
          root: workspace
          paths:
            - "zig-out-release/bin/sig"
            - "zig-out-release/bin/fuzz"
            - "conformance-release/lib/libsolfuzz_sig.so"

  build_check_macos:
    executor: macos-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - restore_cache:
          key: macos-aarch64-0.14.1-{{ checksum "build.zig.zon" }}
      - run:
          name: Build Check
          command: |
            ulimit -Hn unlimited
            ulimit -Sn unlimited
            export PATH="workspace/zig:$PATH"

            # it seems that the feature detection is a bit broken in CircleCI's virtual machines
            # so we will manually say that it's an Apple M4.

            zig build -Denable-tsan=true -Dcpu=apple_m4 --summary all -Dno-run -Dno-bin
      - save_cache:
          key: macos-aarch64-0.14.1-{{ checksum "build.zig.zon" }}
          paths:
            - .zig-cache
            - ~/.cache/zig

  test_macos:
    executor: macos-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - restore_cache:
          key: macos-aarch64-0.14.1-{{ checksum "build.zig.zon" }}
      - run:
          name: Build Tests
          command: workspace/zig/zig build test -Dno-run -Denable-tsan=true -Dcpu=apple_m4 --summary all
      - run:
          name: Run Tests
          command: |
            ulimit -Hn unlimited
            ulimit -Sn unlimited
            zig-out/bin/test 2>&1 | cat
      - save_cache:
          key: macos-aarch64-0.14.1-{{ checksum "build.zig.zon" }}
          paths:
            - .zig-cache
            - ~/.cache/zig

  test_macos_hashmap_ledger:
    executor: macos-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - restore_cache:
          key: macos-aarch64-0.14.1-{{ checksum "build.zig.zon" }}
      - run:
          name: Build Tests
          command: workspace/zig/zig build test -Dno-run -Denable-tsan=true -Dcpu=apple_m4 --summary all -Dlong-tests -Dledger=hashmap -Dfilter="ledger"
      - run:
          name: Run Tests
          command: |
            ulimit -Hn unlimited
            ulimit -Sn unlimited
            zig-out/bin/test 2>&1 | cat
      - save_cache:
          key: macos-aarch64-0.14.1-{{ checksum "build.zig.zon" }}
          paths:
            - .zig-cache
            - ~/.cache/zig

  build_and_test_hashmap:
    executor: linux-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - restore_cache:
          key: linux-x86_64-0.14.1-{{ checksum "build.zig.zon" }}-selfhosted
      - run:
          name: Build Tests
          command: workspace/zig/zig build test -Dno-run -Dlong-tests -Denable-tsan=true -Dledger=hashmap -Dcpu=x86_64_v3 -Dfilter="ledger" --summary all
      - run:
          name: Run Tests
          command: zig-out/bin/test 2>&1 | cat

  test_linux:
    executor: linux-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      # Restore the cache in order to have access to the files which the DWARF info
      # is referencing when dumping stack traces.
      - restore_cache:
          key: linux-x86_64-0.14.1-{{ checksum "build.zig.zon" }}-selfhosted
      - run:
          name: Build Tests
          # Disable network-accessing tests for this job, which behave badly on circleci
          command: workspace/zig/zig build test -Dno-run -Dlong-tests -Dcpu=x86_64_v3 -Denable-tsan=true -Dno-network-tests --summary all
      - run:
          name: Run Tests
          command: zig-out/bin/test 2>&1 | cat

  test_webzockets:
    executor: linux-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - restore_cache:
          key: linux-x86_64-0.14.1-{{ checksum "build.zig.zon" }}-selfhosted
      - run:
          name: Build and Run Webzockets Tests
          command: |
            cd src/rpc/webzockets
            ../../../workspace/zig/zig build test -Dcpu=x86_64_v3 --summary all

  test_webzockets_macos:
    executor: macos-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - restore_cache:
          key: macos-aarch64-0.14.1-{{ checksum "build.zig.zon" }}
      - run:
          name: Build and Run Webzockets Tests
          command: |
            ulimit -Hn unlimited
            ulimit -Sn unlimited
            cd src/rpc/webzockets
            ../../../workspace/zig/zig build test -Dcpu=apple_m4 --summary all

  test_kcov_linux:
    executor: linux-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - restore_cache:
          key: linux-x86_64-0.14.1-{{ checksum "build.zig.zon" }}-selfhosted
      - run:
          name: Build
          command: workspace/zig/zig build test -Dno-run -Dlong-tests -Dtarget=x86_64-linux-gnu.2.36 -Dcpu=x86_64_v3 -Denable-tsan=false -Dno-network-tests --summary all
      - docker_as_user
      - run:
          name: Test and Collect
          command: |
            docker run --security-opt seccomp=unconfined \
                       $DOCKER_MOUNT \
                       kcov/kcov \
                       bash scripts/kcov_ci.sh
      - codecov/upload:
          dir: kcov-merged/kcov-merged

  gossip:
    executor: linux-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - run:
          name: Run Gossip
          command: bash scripts/gossip_test.sh 120 workspace/zig-out-release/bin/sig

  gossip_service_fuzz:
    executor: linux-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - run:
          name: Run Gossip Service Fuzzer
          command: workspace/zig-out-release/bin/fuzz --seed 19 gossip-service 10000

  gossip_table_fuzz:
    executor: linux-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - run:
          name: Run Gossip Table Fuzzer
          command: workspace/zig-out-release/bin/fuzz --seed 19 gossip-table 100000

  allocators_fuzz:
    executor: linux-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - run:
          name: Run Allocators Fuzzer
          command: workspace/zig-out-release/bin/fuzz --seed 19 allocators 10000

  ledger_fuzz:
    executor: linux-executor
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - run:
          name: Run Ledger Fuzzer
          command: workspace/zig-out-release/bin/fuzz --seed 19 ledger 10000

  solana_conformance:
    executor: linux-executor
    # We need a pretty high parallelism since the vm_interp harness has a *lot* of fixtures. Perhaps
    # we can raise it even higher if the transaction harness takes too long?
    parallelism: 6
    steps:
      - checkout
      - attach_workspace:
          at: workspace
      - restore_cache:
          key: linux-x86_64-0.14.1-{{ checksum "build.zig.zon" }}-selfhosted-release
      - run:
          name: Run Fixtures
          command: ./conformance/scripts/ci-run.sh

workflows:
  check_linux:
    jobs:
      - check_style
      - check_docs
      - setup_zig:
          name: setup_zig_linux
          target: "x86_64-linux"
      - lint:
          requires:
            - setup_zig_linux
      - build_linux_release:
          requires:
            - setup_zig_linux
      - build_linux:
          requires:
            - setup_zig_linux
      - build_and_test_hashmap:
          requires:
            - build_linux
      - test_linux:
          requires:
            - build_linux
      - test_webzockets:
          requires:
            - setup_zig_linux
      - test_kcov_linux:
          requires:
            - setup_zig_linux
      - gossip:
          requires:
            - build_linux_release
      - gossip_service_fuzz:
          requires:
            - build_linux_release
      - gossip_table_fuzz:
          requires:
            - build_linux_release
      - allocators_fuzz:
          requires:
            - build_linux_release
      - ledger_fuzz:
          requires:
            - build_linux_release
      - solana_conformance:
          requires:
            - build_linux_release

  check_macos:
    jobs:
      - setup_zig:
          name: setup_zig_macos
          target: "aarch64-macos"
      - build_check_macos:
          requires:
            - setup_zig_macos
      - test_macos:
          requires:
            - build_check_macos
      - test_macos_hashmap_ledger:
          requires:
            - build_check_macos
      - test_webzockets_macos:
          requires:
            - setup_zig_macos
